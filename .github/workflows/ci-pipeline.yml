# CI/CD Pipeline Configuration by Aaron
# This workflow automates the testing and deployment process to prevent broken code from reaching production. [cite: 1]

name: CI/CD Pipeline

on:
  # AUTOMATION: Automatically triggers the pipeline on every push or pull request to the main branch. [cite: 1, 11]
  # This replaces manual code reviews and ensures immediate feedback for the development team. [cite: 7, 10]
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: Continuous Integration (Test)
  # This job acts as a "Gatekeeper" to ensure only high-quality, secure code is allowed to proceed. 
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        # Retrieves the latest codebase from GitHub. [cite: 6]
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          # Standardizes the environment to match our Docker and local setups.
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt  # Installs Flask, requests, and other app requirements.
          pip install flake8 pip-audit      # Installs tools for quality and security checks.

      - name: Lint with flake8   
        # QUALITY: Scans code for syntax errors and logic flaws to prevent functionality breaks. [cite: 7]
        run: |
          # Stop the build if there are Python syntax errors or undefined names.
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Checks for complexity and style violations to keep the codebase maintainable.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Security Scan (Pip Audit) 
        # SECURITY: Automatically checks all installed libraries for known vulnerabilities (CVEs). 
        # This ensures we don't deploy an application with insecure dependencies.
        run: pip-audit

      - name: Run Automated Tests  
        # QUALITY: Executes the test suite in test_app.py to verify feature functionality. [cite: 11, 36]
        # Only if all tests pass can the code be merged or used further. 
        run: pytest -v 

  # JOB 2: Continuous Deployment (Build)
  # This job only runs if the 'test' job passes successfully (the 'needs: test' dependency). 
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Login to Docker Hub
        # SECURITY: Uses GitHub Secrets to securely log in without exposing credentials in the code. 
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and Push Docker Image  
        # DEPLOYMENT & ORCHESTRATION: Builds the container using our secure Multi-Stage Dockerfile.
        # The image is then pushed to Docker Hub, ready for Kubernetes orchestration. [cite: 39]
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/my-app:latest